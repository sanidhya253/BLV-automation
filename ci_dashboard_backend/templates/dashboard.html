<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>BLV CI Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            background-color: #f4f6f8;
            padding: 30px;
        }

        h1 {
            margin-bottom: 10px;
        }

        .subtitle {
            color: #555;
            margin-bottom: 20px;
        }

        .summary {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .card {
            background: white;
            padding: 18px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            min-width: 200px;
        }

        .card h2 {
            margin: 0;
            font-size: 28px;
        }

        .card p {
            margin: 6px 0 0;
            color: #666;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .hint {
            color: #6b7280;
            font-size: 13px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        th,
        td {
            padding: 12px 14px;
            text-align: left;
            border-bottom: 1px solid #eee;
            vertical-align: top;
        }

        th {
            background-color: #1f2937;
            color: white;
            font-weight: normal;
        }

        tr:hover {
            background-color: #f9fafb;
        }

        .status-pass {
            color: #166534;
            background-color: #dcfce7;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: bold;
            display: inline-block;
        }

        .status-fail {
            color: #7f1d1d;
            background-color: #fee2e2;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: bold;
            display: inline-block;
        }

        .mono {
            font-family: monospace;
        }

        .report-links a {
            text-decoration: none;
            font-weight: bold;
            font-size: 13px;
            padding: 6px 10px;
            border-radius: 8px;
            display: inline-block;
            border: 1px solid #e5e7eb;
            background: #ffffff;
        }

        .report-links a:hover {
            background: #f3f4f6;
        }

        footer {
            margin-top: 30px;
            text-align: center;
            color: #777;
            font-size: 13px;
        }
    </style>
</head>

<body>

    <h1>BLV CI Dashboard</h1>
    <div class="subtitle">
        Continuous Business Logic Vulnerability Monitoring
    </div>

    <!-- SUMMARY CARDS -->
    {% set ns = namespace(fail_count=0) %}
    {% for r in results %}
      {% if r[3] and r[3]|trim|upper == "FAIL" %}
        {% set ns.fail_count = ns.fail_count + 1 %}
      {% endif %}
    {% endfor %}
    
    <div class="summary">
      <div class="card">
        <h2>{{ results|length }}</h2>
        <p>Total CI Runs</p>
      </div>
    
      <div class="card">
        <h2>{{ ns.fail_count }}</h2>
        <p>Failed Runs</p>
      </div>
    
      <div class="card">
        <h2>{{ results|length - ns.fail_count }}</h2>
        <p>Successful Runs</p>
      </div>
    </div>

    <div class="summary" style="align-items: flex-start;">
      <!-- LEFT: Trend -->
      <div class="card" style="flex: 2; min-width: 520px;">
        <h2 style="font-size:15px; margin:0 0 10px 0;">Trend (Last 14 Days)</h2>
        <div style="width: 100%; height: 260px;">
          <canvas id="trendChart"></canvas>
        </div>
        <p style="margin-top:10px; font-size:13px; color:#666; text-align:center;">
          Daily CI outcomes (PASS vs FAIL)
        </p>
      </div>
    
      <!-- RIGHT: Severity chart -->
      <div class="card" style="flex: 1; min-width: 320px;">
        <h2 style="font-size:15px; margin:0 0 10px 0;">Failure Severity (Last 14 Days)</h2>
        <div style="width: 100%; height: 260px;">
          <canvas id="severityChart"></canvas>
        </div>
        <p style="margin-top:10px; font-size:13px; color:#666; text-align:center;">
          Severity distribution of failed rules
        </p>
      </div>
    </div>




    <div class="toolbar">
        <div class="hint">
            Tip: Use <b>PDF/JSON</b> to view full scan details for each run.
        </div>
    </div>

    <!-- TABLE (MINIMAL VIEW) -->
    <table>
        <thead>
            <tr>
                <th>Run ID</th>
                <th>Commit</th>
                <th>Branch</th>
                <th>Status</th>
                <th>Report</th>
                <th>Time</th>
            </tr>
        </thead>

        <tbody>
            {% for row in results %}
            <tr>
                <td class="mono">{{ row[0] }}</td>

                <td class="mono">
                    {{ row[1][:10] }}
                </td>

                <td>{{ row[2] }}</td>

                <td>
                    {% if row[3] and row[3]|trim|upper == "PASS" %}
                        <span class="status-pass">PASS</span>
                    {% else %}
                        <span class="status-fail">FAIL</span>
                    {% endif %}
                </td>

                <td class="report-links">
                    <a href="/report/{{ row[0] }}.json">JSON</a>
                    &nbsp;
                    <a href="/report/{{ row[0] }}.pdf">PDF</a>
                </td>

                <td>{{ row[7] }}</td>
            </tr>
            {% endfor %}
        </tbody>

    </table>

    <footer>
        BLV Automation Framework Â· CI/CD Business Logic Monitoring
    </footer>


    <script>
      async function renderTrendChart() {
        try {
          const res = await fetch('/api/stats/daily');
          const data = await res.json();
    
          const labels = data.map(x => x.date);
          const passSeries = data.map(x => x.pass);
          const failSeries = data.map(x => x.fail);
    
          const ctx = document.getElementById('trendChart').getContext('2d');
    
          new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [
                { label: 'PASS', data: passSeries, tension: 0.3 },
                { label: 'FAIL', data: failSeries, tension: 0.3 }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' }
              },
              scales: {
                y: { beginAtZero: true, ticks: { precision: 0 } }
              }
            }
          });
        } catch (e) {
          console.log("Trend chart error:", e);
        }
      }
    
      renderTrendChart();


      async function renderSeverityChart() {
        try {
          const res = await fetch('/api/stats/severity');
          const counts = await res.json();
    
          const labels = ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW'];
          const values = labels.map(k => counts[k] || 0);
    
          const ctx = document.getElementById('severityChart').getContext('2d');
          new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: labels,
              datasets: [{
                data: values,
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' }
              },
              cutout: '65%'
            }
          });
        } catch (e) {
          console.log("Severity chart error:", e);
        }
      }
    
      renderSeverityChart();
    </script>



</body>

</html>
