name: Business Logic Validation

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  blv-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Start OWASP Juice Shop
        run: |
          echo "=== Pulling and starting OWASP Juice Shop ==="
          docker pull bkimminich/juice-shop
          docker run -d -p 3000:3000 --name juice-shop bkimminich/juice-shop
          
          echo "=== Waiting for Juice Shop to be ready ==="
          for i in {1..40}; do
            if curl -f -s http://localhost:3000 >/dev/null 2>&1; then
              echo "Juice Shop is up and running!"
              break
            fi
            echo "Attempt $i/40: Waiting for app..."
            sleep 5
          done
          
          if [ $i -eq 40 ]; then
            echo "ERROR: Juice Shop failed to start" >&2
            docker logs juice-shop
            exit 1
          fi

      - name: Run Business Logic Rule Validator
        env:
          TARGET_URL: http://localhost:3000
        run: |
          echo "=== Running BLV Validator against OWASP Juice Shop ==="
          python blv_rule_validator.py $TARGET_URL

      - name: Cleanup Docker Container
        if: always()
        run: |
          echo "=== Cleaning up Juice Shop container ==="
          docker stop juice-shop || true
          docker rm juice-shop || true
