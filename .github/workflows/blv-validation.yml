name: Business Logic Validation

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  blv-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python Dependencies
        run: |
          pip install requests

      - name: Build and Start Vulnerable App
        run: |
          echo "Building Docker image for vulnerable app..."
          cd vulnerable_app
          docker build -t vuln-app .
          echo "Starting vulnerable app on port 5000..."
          docker run -d -p 5000:5000 --name vuln-app vuln-app
          echo "Waiting for app to be ready..."
          for i in {1..30}; do
            if curl -s http://localhost:5000 >/dev/null 2>&1; then
              echo "Vulnerable app is up and running!"
              break
            fi
            echo "Attempt $i/30: Waiting for app..."
            sleep 3
          done
          if [ $i -eq 30 ]; then
            echo "Failed to start vulnerable app" >&2
            exit 1
          fi

      - name: Run Business Logic Rule Validator
        env:
          TARGET_URL: http://localhost:5000
        run: |
          python blv_rule_validator.py $TARGET_URL

      - name: Cleanup Container
        if: always()
        run: |
          docker stop vuln-app || true
          docker rm vuln-app || true
